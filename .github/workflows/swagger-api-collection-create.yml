name: swagger api create collection

on:
  workflow_run:
    workflows: ["check application runnable"]
    types:
      - completed
  push:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
          java-version: 17
          distribution: 'oracle'

    - name: Set up Docker Compose
      run: |
        sudo apt-get install -y docker-compose
        sudo systemctl start docker
        
        
    - name: Start PostgreSQL container
      run: |
          docker run --name pg -d -p 5432:5432 \
            -e POSTGRES_USER=trankwilizator \
            -e POSTGRES_PASSWORD=517881m \
            -e POSTGRES_DB=tafl_db \
            postgres:15-alpine

    - name: Create jar
      run: mvn clean package

    - name: Pg down
      run: docker stop pg

    - name: Build and run Docker Compose
      run: |
        docker-compose build
        docker-compose up -d

    - name: Wait for services to start
      run: sleep 10

    - name: Generate Postman collection
      run: |
        npm install -g newman postman-collection
        newman run http://localhost:8080/v3/api-docs --export-collection postman_collection.json

    - name: Upload Postman collection artifact
      uses: actions/upload-artifact@v2
      with:
        name: postman_collection
        path: postman_collection.json

    - name: Upload collection to Postman
      run: |
        curl --request PUT \
          --url ${{ secrets.POSTMAN_COLLECTION_URL }} \
          --header "X-Api-Key: ${{ secrets.POSTMAN_API_KEY }}" \
          --header "Content-Type: application/json" \
          --data "@postman_collection.json"
